<!DOCTYPE html>
<html lang="en">
<head>
	<% var username = username; var user = user; var allEvents = allEvents %>
	<% include ./partials/head %>
</head>
<body class="container">

	<header>
		<% include ./partials/flash %>
		<% include ./partials/header %>
	</header>

	<main>
		<div class="row">
			<div class="col-sm-8">
				<div class="jumbotron">
					<h1>Upcoming CS Events</h1>

					<section id="list-view">

						<% for(var i=0; i < allEvents.length; i++) { %>
							<!-- Individual event div -->
							<article id="event-<%= allEvents[i]._id %>">

								<!-- Event Name -->
								<h3><a href="/event/<%= allEvents[i]._id %>"><%= allEvents[i].name %></a></h3>

								<p>

									<!-- Start/end date and time -->
									<% if (allEvents[i].endTime == null) { %>
										<!-- No end date specified -->
										<%= getDateTimePrettyFormat(allEvents[i].startTime) %>
									<% } else if (getDateTimeStr(allEvents[i].startTime).substr(0,10) == getDateTimeStr(allEvents[i].endTime).substr(0,10)) { %>
										<!-- Same start/end dates -->
										<%= getDateTimePrettyFormat(allEvents[i].startTime) %> - <%= getDateTimePrettyFormat(allEvents[i].endTime).substr(16) %>
									<% } else { %>
										<!-- Different start/end dates -->
										<%= getDateTimePrettyFormat(allEvents[i].startTime) %> - <%= getDateTimePrettyFormat(allEvents[i].endTime) %>
									<% } %>

									<!-- Location (required) -->
									<br><%= allEvents[i].location %>

									<!-- RSVP Limit -->
									<% var registered = allEvents[i].rsvpUsers.length %>
									<% if (allEvents[i].rsvpLimit != null) { %>
										<br>RSVP Limit: <%= registered %>/<%= allEvents[i].rsvpLimit %>
									<% } else { %>
										<br>Attendees Registered: <%= registered %> %>
									<% } %>

									<!-- Description -->
									<% if (allEvents[i].description != null) { %><br><%= allEvents[i].description %><% } %>


								</p>




                                <% if (user != null && user.roles.type.user) {%>
									<% if (JSON.stringify(allEvents[i].rsvpUsers).indexOf("\"" + username + "\"") == -1) { %>
										<% if ((allEvents[i].rsvpUsers.length == 0) || (allEvents[i].rsvpLimit > allEvents[i].rsvpUsers.length)) { %>

											<!-- Show RSVP button if user is not currently RSVP'd and if there is still space to RSVP  -->
											<form action="/event/<%= allEvents[i]._id %>/rsvp" method="POST" style="display: inline-block">
												<button id=<%= `rsvp-${allEvents[i]._id}` %> class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>/rsvp'"><i class="fa fa-calendar-check-o"></i> I'm Attending</button>
											</form>


										<% } %>
									<% } else { %>
										<!-- Show UnRSVP button if user is already RSVP'd to the event -->
										<form class="form-horizontal" action="/event/<%=allEvents[i]._id%>/resume" method="POST" enctype="multipart/form-data">
											<!-- Select Basic -->
											<div class="form-group">
												<div class="col-md-6">
													<select id=<%= `resume-${allEvents[i]._id}` %> name="shareresume" class="form-control" onchange="onEventResumeChange(this)">
														<option value="None">Do not share resume</option>
														<option value="Profile">Share profile resume</option>
														<option value="Custom">Share custom resume</option>
													</select>
												</div>
											</div>

											<!-- File Button -->
											<div id="<%=`upload-${allEvents[i]._id}`%>" class="form-group" hidden>
												<div class="col-md-6">
													<label class="control-label">Upload custom resume</label>
													<input id="resume" name="resume" class="input-file" type="file">
													<span id=<%= `currently-uploaded-${allEvents[i]._id}` %> class="help-block">Currently uploaded: <%= (allEvents[i].resumes && allEvents[i].resumes.findIndex((resume) => user.username === resume.user) > -1 && allEvents[i].resumes[allEvents[i].resumes.findIndex((resume) => user.username === resume.user)].option === 'Custom') ? allEvents[i].resumes[allEvents[i].resumes.findIndex((resume) => user.username === resume.user)].eventResume.type.originalName : 'None' %></span>
													<button name="submit" class="btn btn-primary btn-sm">Upload resume</button>
												</div>

											</div>
										</form>




										<form action="/event/<%= allEvents[i]._id %>/unrsvp" method="POST" style="display: inline-block">
											<button id=<%= `rsvp-${allEvents[i]._id}` %> class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>/unrsvp'"><i class="fa fa-calendar-times-o"></i> I'm Not Attending</button>
										</form>


									<% } %>


									 <button id=<%= `show-${allEvents[i]._id}` %> class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>'"><i class="fa fa-info-circle"></i> Event Details</button>
								<% } %>
								<% if (user != null && (user.roles.type.admin || user.roles.type.superuser)) { %>
									<br>
									<button class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>/download_resume_book'"><i class="fa fa-book"></i> Download resume book </button>
									<button id=<%= `edit-${allEvents[i]._id}` %> class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>/edit'"><i class="fa fa-edit"></i> Edit Event</button>
									<button id=<%= `duplicate-${allEvents[i]._id}` %> class="btn btn-default" onclick="location.href='/event/<%= allEvents[i]._id %>/duplicate'"><i class="fa fa-copy"></i> Duplicate Event</button>
									<button id=<%= `delete-${allEvents[i]._id}` %> data-record-id="<%= allEvents[i]._id %>" data-record-title="<%= allEvents[i].name %>" class="btn btn-danger" data-toggle="modal" data-target="#confirm-delete"><i class="fa fa-trash"></i> Delete Event</button>
								<% } %>

							</article>

						<% } %>
					</section>

				</div><!-- Jumbotron -->
			</div><!-- col-sm-8 -->
			<div class="col-sm-4">

				<div class="well">
					<h2>Filter Events</h2>
					<form action="/" method="GET">
						<fieldset>
							<!-- Text input-->
							<div class="form-group">
								<label class="control-label" for="text">Search events:</label>
								<div>
									<input id="searchinput" name="text" type="text" placeholder="" class="form-control input-md">

								</div>
							</div>

							<!-- Select Multiple -->
							<div class="form-group">
								<label class="control-label" for="tags">Filter events by tag(s):</label>
								<div>
									<select id="tagselect" name="tags" class="form-control" multiple="multiple">
										<% for (let i=0; i < tags.length; i++) { %>
											<option value="<%= tags[i] %>"><%= tags[i] %></option>
										<% }%>
									</select>
								</div>
							</div>

							<!-- Button -->
							<button id="searchsubmit" name="searchsubmit" class="btn btn-primary">Filter</button>
						</fieldset>
					</form>
				</div>
			</div>
		</div>
	</main>

	<footer>
		<% include ./partials/footer %>
	</footer>

	<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                    <h4 class="modal-title" id="myModalLabel">Confirm Delete</h4>
                </div>
                <div class="modal-body">
                    <p>You are about to delete the <b><i class="title"></i></b> event. This procedure is irreversible.</p>
                    <p>Do you want to proceed?</p>
                </div>
                <div class="modal-footer">
									<button type="button" class="btn btn-danger btn-ok">Delete</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

	<script>
			$('#confirm-delete').on('click', '.btn-ok', function(e) {
			    var $modalDiv = $(e.delegateTarget);
			    var id = $(this).data('recordId');
			    // $.ajax({url: '/api/record/' + id, type: 'DELETE'})
			    $.post('/event/' + id + '/delete', function(data, status) {
						console.log("Status: " + status);
						setTimeout(function() {
							$modalDiv.modal('hide').removeClass('loading');
							window.location = "/";
						}, 250)
					});
			    $modalDiv.addClass('loading');
			});
			$('#confirm-delete').on('show.bs.modal', function(e) {
			    var data = $(e.relatedTarget).data();
			    $('.title', this).text(data.recordTitle);
			    $('.btn-ok', this).data('recordId', data.recordId);
			});

			function onEventResumeChange(selectedObj) {
				let eventId = selectedObj.id.substring(7);

				if (selectedObj.value !== 'Custom') {
					$(`#upload-${eventId}`).hide();
					$(`#currently-uploaded-${eventId}`).text('Currently uploaded: None');
					$.post(`/event/${eventId}/resume`, { action: selectedObj.value });
				} else {
					$(`#upload-${eventId}`).show();
				}
			}

			function initializeEventSpecificResumes() {
				<%
					let resumeOptions = {};

					for (let j = 0; j < allEvents.length; j++) {
						let resumes = allEvents[j].resumes;

						let k = resumes.findIndex((resume) => user.username === resume.user);

						if (k > -1) {
							resumeOptions[allEvents[j]._id] = resumes[k].option;
						}
					}
				%>

				let resumeOptions = JSON.parse('<%- JSON.stringify(resumeOptions); %>');

				for (let id in resumeOptions) {
					$(`#resume-${id}`).val(resumeOptions[id]);
					if (resumeOptions[id] === 'Custom') {
						$(`#upload-${id}`).show();
					}
				}
			}

			initializeEventSpecificResumes();
    </script>

</body>
</html>
